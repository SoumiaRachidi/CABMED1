@{
    ViewBag.Title = "Espace Patient";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@functions {
    private string GetActivityProperty(object activity, params string[] propertyNames)
    {
        if (activity == null || propertyNames == null)
        {
            return null;
        }

        var dictionary = activity as System.Collections.Generic.IDictionary<string, object>;
        foreach (var name in propertyNames)
        {
            if (string.IsNullOrWhiteSpace(name))
            {
                continue;
            }

            if (dictionary != null && dictionary.TryGetValue(name, out var dictValue))
            {
                return dictValue?.ToString();
            }

            var property = activity.GetType().GetProperty(name);
            if (property != null)
            {
                var value = property.GetValue(activity, null);
                if (value != null)
                {
                    return value.ToString();
                }
            }
        }

        return null;
    }
}

<style>
    /* Professional medical minimalist theme - consistent with Admin dashboard */
    :root {
        --primary:#2b7de9;        /* light blue */
        --accent:#2ecc71;         /* medical green */
        --warning:#e67e22;        /* orange */
        --danger:#e74c3c;         /* red */
        --muted:#6c757d;
        --bg:#ffffff;
        --card:#f8f9fa;
        --border:#e9ecef;
    }
    .patient-dashboard { background: var(--bg); }
    .metric-card { border:1px solid var(--border); border-radius:12px; background: var(--card); padding:22px; box-shadow:0 2px 8px rgba(0,0,0,.03); }
    .metric-card .value { font-size:40px; font-weight:700; margin:6px 0; }
    .metric-card .label { color: var(--muted); }
    .metric-icon { width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:10px; color:#fff; }
    .metric-icon.primary { background: var(--primary); }
    .metric-icon.accent { background: var(--accent); }
    .metric-icon.warning { background: var(--warning); }
    .metric-icon.danger { background: var(--danger); }

    .quick-actions .btn { border-radius:10px; padding:14px 18px; font-weight:600; margin-right:8px; margin-bottom:8px; }
    .panel-clean { border:1px solid var(--border); border-radius:12px; background: var(--card); }
    .panel-clean .panel-heading { padding:16px 18px; border-bottom:1px solid var(--border); background:#fff; border-radius:12px 12px 0 0; }
    .panel-clean .panel-body { padding:18px; }

    .form-control { border-radius:10px; }
    .appointment-card { border-left:4px solid var(--primary); background:#fff; padding:16px; margin:8px 0; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,.1); }
    .appointment-card.urgent { border-left-color: var(--warning); }
    
    .health-info { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border-radius:12px; padding:20px; }
    .health-info h4 { margin-top:0; }

    @@media (max-width: 768px) {
        .metric-card { margin-bottom:16px; }
        .quick-actions .btn { display:block; width:100%; margin-right:0; }
    }
</style>

<div class="container patient-dashboard" style="margin-top: 24px;">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex" style="align-items:center; justify-content:space-between;">
                <div>
                    <h2 style="margin:0;">Espace Patient</h2>
                    <p class="text-muted" style="margin:4px 0 16px;">Bienvenue, @ViewBag.UserName</p>
                </div>
                <div class="quick-actions">
                    <a href="@Url.Action("BookAppointment", "Patient")" class="btn btn-primary">
                        <span class="glyphicon glyphicon-calendar"></span> Prendre rendez-vous
                    </a>
                    <a href="@Url.Action("MyAppointments", "Patient")" class="btn btn-info">
                        <span class="glyphicon glyphicon-list-alt"></span> Mes rendez-vous
                    </a>
                    <a href="@Url.Action("MedicalHistory", "Patient")" class="btn btn-success">
                        <span class="glyphicon glyphicon-file-text"></span> Mon dossier médical
                    </a>
                    <a href="@Url.Action("Logout", "Auth")" class="btn btn-default">
                        <span class="glyphicon glyphicon-log-out"></span> Déconnexion
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Health Status Overview -->
    <div class="row" style="margin-top: 8px;">
        <div class="col-md-4">
            <div class="metric-card">
                <div class="d-flex" style="gap:12px; align-items:center;">
                    <div class="metric-icon primary">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </div>
                    <div>
                        <div class="value" style="color: var(--primary);">@(ViewBag.UpcomingAppointments ?? 0)</div>
                        <div class="label">Prochains rendez-vous</div>
                    </div>
                </div>
                <div class="text-right" style="margin-top:10px;">
                    <a href="@Url.Action("MyAppointments", "Patient")" class="btn btn-link">Voir détails</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="d-flex" style="gap:12px; align-items:center;">
                    <div class="metric-icon accent">
                        <span class="glyphicon glyphicon-ok-sign"></span>
                    </div>
                    <div>
                        <div class="value" style="color: var(--accent);">@(ViewBag.CompletedAppointments ?? 0)</div>
                        <div class="label">Consultations terminées</div>
                    </div>
                </div>
                <div class="text-right" style="margin-top:10px;">
                    <a href="@Url.Action("MedicalHistory", "Patient")" class="btn btn-link">Voir détails</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="metric-card">
                <div class="d-flex" style="gap:12px; align-items:center;">
                    <div class="metric-icon warning">
                        <span class="glyphicon glyphicon-exclamation-sign"></span>
                    </div>
                    <div>
                        <div class="value" style="color: var(--warning);">@(ViewBag.PendingResults ?? 0)</div>
                        <div class="label">Résultats en attente</div>
                    </div>
                </div>
                <div class="text-right" style="margin-top:10px;">
                    <a href="@Url.Action("TestResults", "Patient")" class="btn btn-link">Voir détails</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Section -->
    <div class="row" style="margin-top:24px;">
        <div class="col-md-6">
            <div class="panel-clean">
                <div class="panel-heading">
                    <strong><span class="glyphicon glyphicon-flash"></span> Actions rapides</strong>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-sm-6">
                            <a href="@Url.Action("BookAppointment", "Patient")" class="btn btn-primary btn-block">
                                <span class="glyphicon glyphicon-plus"></span><br>
                                Nouveau rendez-vous
                            </a>
                        </div>
                        <div class="col-sm-6">
                            <a href="@Url.Action("EmergencyContact", "Patient")" class="btn btn-danger btn-block">
                                <span class="glyphicon glyphicon-phone"></span><br>
                                Contact d'urgence
                            </a>
                        </div>
                    </div>
                    <div class="row" style="margin-top:12px;">
                        <div class="col-sm-6">
                            <a href="@Url.Action("MyPrescriptions", "Patient")" class="btn btn-info btn-block">
                                <span class="glyphicon glyphicon-list"></span><br>
                                Mes ordonnances
                            </a>
                        </div>
                        <div class="col-sm-6">
                            <a href="@Url.Action("UpdateProfile", "Patient")" class="btn btn-warning btn-block">
                                <span class="glyphicon glyphicon-user"></span><br>
                                Mon profil
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="health-info">
                <h4><span class="glyphicon glyphicon-heart"></span> Informations de santé</h4>
                <p>Restez informé(e) de vos prochains rendez-vous et suivez votre parcours de soins.</p>
                <div class="row">
                    <div class="col-xs-6">
                        <strong>Prochain RDV:</strong><br>
                        <small>@(ViewBag.NextAppointmentDate ?? "Aucun prévu")</small>
                    </div>
                    <div class="col-xs-6">
                        <strong>Médecin traitant:</strong><br>
                        <small>@(ViewBag.PrimaryDoctor ?? "Non défini")</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row" style="margin-top:24px;">
        <div class="col-md-12">
            <div class="panel-clean">
                <div class="panel-heading">
                    <strong><span class="glyphicon glyphicon-time"></span> Activité récente</strong>
                </div>
                <div class="panel-body">
                    @if (ViewBag.RecentActivity != null && ((IEnumerable<dynamic>)ViewBag.RecentActivity).Any())
                    {
                        foreach (var activity in (IEnumerable<dynamic>)ViewBag.RecentActivity)
                        {
                            var activityType = GetActivityProperty(activity, "Type", "ActivityType", "Title") ?? "Activité";
                            var activityDescription = GetActivityProperty(activity, "Description", "Details", "Message") ?? "Description non disponible";
                            var activityDate = GetActivityProperty(activity, "Date", "CreatedDate", "DateHeure") ?? string.Empty;
                            <div class="appointment-card">
                                <div class="d-flex" style="justify-content:space-between; align-items:center;">
                                    <div>
                                        <h5 style="margin:0;">@activityType</h5>
                                        <p class="text-muted" style="margin:4px 0;">@activityDescription</p>
                                    </div>
                                    <div class="text-right">
                                        <small class="text-muted">@activityDate</small>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted" style="padding:40px;">
                            <span class="glyphicon glyphicon-inbox" style="font-size:48px; opacity:0.3;"></span>
                            <p style="margin-top:16px;">Aucune activité récente</p>
                            <a href="@Url.Action("BookAppointment", "Patient")" class="btn btn-primary">Prendre votre premier rendez-vous</a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Health Tips Section -->
    <div class="row" style="margin-top:24px;">
        <div class="col-md-12">
            <div class="panel-clean">
                <div class="panel-heading">
                    <strong><span class="glyphicon glyphicon-info-sign"></span> Conseils santé</strong>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div style="text-align:center; padding:20px;">
                                <div class="metric-icon accent" style="margin:0 auto 12px;">
                                    <span class="glyphicon glyphicon-heart"></span>
                                </div>
                                <h5>Suivi régulier</h5>
                                <p class="text-muted">Respectez vos rendez-vous de contrôle pour un suivi optimal de votre santé.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="text-align:center; padding:20px;">
                                <div class="metric-icon primary" style="margin:0 auto 12px;">
                                    <span class="glyphicon glyphicon-phone"></span>
                                </div>
                                <h5>Contact d'urgence</h5>
                                <p class="text-muted">En cas d'urgence médicale, contactez immédiatement les services d'urgence.</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="text-align:center; padding:20px;">
                                <div class="metric-icon warning" style="margin:0 auto 12px;">
                                    <span class="glyphicon glyphicon-list-alt"></span>
                                </div>
                                <h5>Ordonnances</h5>
                                <p class="text-muted">Suivez vos prescriptions et n'hésitez pas à poser des questions à votre médecin.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    // Simple interactivity for better user experience
    $(document).ready(function() {
        // Highlight upcoming appointments
        $('.appointment-card').hover(
            function() { $(this).addClass('shadow-lg'); },
            function() { $(this).removeClass('shadow-lg'); }
        );
        
        // Auto-refresh metrics every 5 minutes (optional)
        // setInterval(function() {
        //     location.reload();
        // }, 300000);
    });
</script>
}
