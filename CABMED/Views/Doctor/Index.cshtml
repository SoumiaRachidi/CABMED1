@{
    ViewBag.Title = "Espace Médecin";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container" style="margin-top:30px;">
    <div class="jumbotron">
        <h2>Bienvenue Dr. @ViewBag.UserName</h2>
        <p class="lead">Ceci est votre tableau de bord médecin.</p>
        <p>
            <a class="btn btn-primary btn-lg" href="@Url.Action("Logout", "Auth")" role="button">Se déconnecter</a>
        </p>
    </div>

    <div class="panel panel-primary">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-calendar"></span> Rendez-vous du jour (@DateTime.Today.ToString("dd/MM/yyyy"))
            </h3>
        </div>
        <div class="panel-body">
            <div id="appointments-loading" class="text-center">
                <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Chargement...
            </div>
            <div id="appointments-container" style="display:none;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th style="width:90px;">Heure</th>
                                <th>Patient</th>
                                <th>Téléphone</th>
                                <th>Motif</th>
                                <th style="width:110px;">Statut</th>
                                <th style="width:260px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="appointments-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div id="appointments-empty" class="alert alert-info" style="display:none;">
                <span class="glyphicon glyphicon-info-sign"></span> Aucun rendez-vous aujourd'hui.
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-time"></span> Prochains rendez-vous
            </h3>
        </div>
        <div class="panel-body">
            <div id="upcoming-loading" class="text-center">
                <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate"></span> Chargement...
            </div>
            <div id="upcoming-container" style="display:none;">
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th style="width:140px;">Date</th>
                                <th style="width:90px;">Heure</th>
                                <th>Patient</th>
                                <th>Téléphone</th>
                                <th>Motif</th>
                                <th style="width:110px;">Statut</th>
                                <th style="width:260px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="upcoming-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div id="upcoming-empty" class="alert alert-info" style="display:none;">
                <span class="glyphicon glyphicon-info-sign"></span> Aucun rendez-vous à venir.
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function(){
        fetchTodayAppointments();
        fetchUpcomingAppointments();

        function formatDateFromNet(value) {
            if (!value) return '';
            var match = /Date\((\d+)\)/.exec(value);
            var date = match ? new Date(parseInt(match[1], 10)) : new Date(value);
            if (isNaN(date.getTime())) return '';
            var d = ('0' + date.getDate()).slice(-2);
            var m = ('0' + (date.getMonth() + 1)).slice(-2);
            var y = date.getFullYear();
            var h = ('0' + date.getHours()).slice(-2);
            var min = ('0' + date.getMinutes()).slice(-2);
            return { date: d + '/' + m + '/' + y, time: h + ':' + min };
        }

        function buildActions(rendezVousId, consultationId) {
            var html = '';

            // View patient records button
            html += '<a href="@Url.Action("ViewRecords","Doctor")/' + rendezVousId + '" ' +
                    'class="btn btn-xs btn-info" title="Voir l\'historique médical">' +
                    '<span class="glyphicon glyphicon-folder-open"></span> View records' +
                    '</a> ';

            // Start consultation button - redirects to consultation form
            if (!consultationId) {
                html += '<a href="@Url.Action("StartConsultation","Doctor")/' + rendezVousId + '" ' +
                        'class="btn btn-xs btn-primary">' +
                        '<span class="glyphicon glyphicon-pencil"></span> Start consultation' +
                        '</a> ';
            } else {
                html += '<span class="label label-success">Consultation démarrée</span> ';
            }

            // Prescribe button - only enabled if consultation exists
            if (consultationId) {
                html += '<a href="@Url.Action("AddPrescription","Doctor")/' + consultationId + '" ' +
                        'class="btn btn-xs btn-success">' +
                        '<span class="glyphicon glyphicon-list-alt"></span> Prescribe' +
                        '</a>';
            } else {
                html += '<button type="button" class="btn btn-xs btn-default" disabled="disabled" ' +
                        'title="Démarrez d\'abord la consultation">' +
                        '<span class="glyphicon glyphicon-list-alt"></span> Prescribe' +
                        '</button>';
            }

            return html;
        }

        function formatStatus(status) {
            var value = (status || 'En attente');
            var normalized = value.toLowerCase();
            var css = 'label-default';

            if (normalized.indexOf('confirm') === 0 || normalized.indexOf('approuv') === 0) {
                css = 'label-success';
            } else if (normalized.indexOf('refus') === 0 || normalized.indexOf('annul') === 0) {
                css = 'label-danger';
            } else if (normalized.indexOf('attente') === 0) {
                css = 'label-warning';
            }

            return '<span class="label ' + css + '">' + value + '</span>';
        }

        function fetchTodayAppointments(){
            $.ajax({
                url: '@Url.Action("TodayAppointments","Doctor")',
                type: 'GET',
                dataType: 'json',
                success: function(data){
                    $('#appointments-loading').hide();
                    if (data && data.length){
                        var tb = $('#appointments-tbody');
                        tb.empty();
                        data.forEach(function(a){
                            var info = formatDateFromNet(a.DateHeureDebut);
                            var heureDebut = a.HeureDebut || (info ? info.time : '');
                            var status = a.Statut || '—';
                            var row = '<tr>'+
                                '<td><strong>'+ heureDebut +'</strong></td>'+
                                '<td>'+ (a.PatientPrenom || '') +' '+ (a.PatientNom || '') +'</td>'+
                                '<td>'+ (a.PatientTelephone || 'N/A') +'</td>'+
                                '<td>'+ (a.Motif || '-') +'</td>'+
                                '<td>'+ formatStatus(a.Statut) +'</td>'+
                                '<td>'+ buildActions(a.RendezVousId, a.ConsultationId) +'</td>'+
                                '</tr>';
                            tb.append(row);
                        });
                        $('#appointments-container').show();
                    } else {
                        $('#appointments-empty').show();
                    }
                },
                error: function(){
                    $('#appointments-loading').hide();
                    $('#appointments-empty').html('<span class="glyphicon glyphicon-warning-sign"></span> Erreur de chargement.').show();
                }
            });
        }

        function fetchUpcomingAppointments(){
            $.ajax({
                url: '@Url.Action("UpcomingAppointments","Doctor")',
                type: 'GET',
                dataType: 'json',
                success: function(data){
                    $('#upcoming-loading').hide();
                    if (data && data.length){
                        var tb = $('#upcoming-tbody');
                        tb.empty();
                        data.forEach(function(a){
                            var info = formatDateFromNet(a.DateHeureDebut);
                            var date = info ? info.date : '';
                            var heure = a.HeureDebut || (info ? info.time : '');
                            var status = a.Statut || '—';
                            var row = '<tr>'+
                                '<td>'+ date +'</td>'+
                                '<td><strong>'+ heure +'</strong></td>'+
                                '<td>'+ (a.PatientPrenom || '') +' '+ (a.PatientNom || '') +'</td>'+
                                '<td>'+ (a.PatientTelephone || 'N/A') +'</td>'+
                                '<td>'+ (a.Motif || '-') +'</td>'+
                                '<td>'+ formatStatus(a.Statut) +'</td>'+
                                '<td>'+ buildActions(a.RendezVousId, a.ConsultationId) +'</td>'+
                                '</tr>';
                            tb.append(row);
                        });
                        $('#upcoming-container').show();
                    } else {
                        $('#upcoming-empty').show();
                    }
                },
                error: function(){
                    $('#upcoming-loading').hide();
                    $('#upcoming-empty').html('<span class="glyphicon glyphicon-warning-sign"></span> Erreur de chargement.').show();
                }
            });
        }
    })();
</script>
<style>
    .glyphicon-refresh-animate { animation: spin 1s linear infinite; }
    @@keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
</style>
}
